name: Build Android Preview Image

on:
  push:
    branches: [main]
    paths: [Dockerfile]
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # Weekly on Monday at 06:00 UTC

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: eslam18/mobile-app-generator/android-preview
  API_LEVEL: "34"
  SYSTEM_IMAGE: "system-images;android-34;default;x86_64"
  AVD_ID: "mag_mobile_preview_api_34"
  DEVICE_PROFILE: "pixel_6"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ── Phase 1: Build base image (SDK + AVD + userdata, no snapshot) ──
      - name: "Phase 1: Build base image (SKIP_SNAPSHOT=true)"
        run: |
          docker build -f Dockerfile \
            --build-arg API_LEVEL=${{ env.API_LEVEL }} \
            --build-arg SYSTEM_IMAGE="${{ env.SYSTEM_IMAGE }}" \
            --build-arg AVD_ID=${{ env.AVD_ID }} \
            --build-arg DEVICE_PROFILE=${{ env.DEVICE_PROFILE }} \
            --build-arg SKIP_SNAPSHOT=true \
            -t android-preview-base:local .

      # ── Phase 2: Boot emulator with KVM, save snapshot, commit ──
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: "Phase 2: Boot emulator with KVM and save snapshot"
        timeout-minutes: 5
        run: |
          CONTAINER_ID=$(docker run -d \
            --device /dev/kvm \
            -v "${{ github.workspace }}/ci/boot-and-snapshot.sh:/tmp/boot-and-snapshot.sh:ro" \
            -e AVD_ID=${{ env.AVD_ID }} \
            -e API_LEVEL=${{ env.API_LEVEL }} \
            -e SYSTEM_IMAGE="${{ env.SYSTEM_IMAGE }}" \
            -e BOOT_TIMEOUT=300 \
            android-preview-base:local \
            bash /tmp/boot-and-snapshot.sh)

          echo "Container: ${CONTAINER_ID}"
          docker logs -f "${CONTAINER_ID}" &
          LOGS_PID=$!

          EXIT_CODE=$(docker wait "${CONTAINER_ID}")
          kill $LOGS_PID 2>/dev/null || true

          if [ "$EXIT_CODE" != "0" ]; then
            echo "ERROR: boot-and-snapshot.sh exited with code ${EXIT_CODE}"
            docker logs "${CONTAINER_ID}"
            exit 1
          fi

          echo "==> Committing container as final image..."
          docker commit "${CONTAINER_ID}" android-preview-final:local
          docker rm "${CONTAINER_ID}"

      # ── Phase 3: Verify sentinel and snapshot in final image ──
      - name: "Phase 3: Verify final image"
        run: |
          echo "==> Checking sentinel file..."
          docker run --rm android-preview-final:local \
            cat /opt/android-sdk-linux/.mag-prebaked

          echo ""
          echo "==> Checking snapshot directory..."
          docker run --rm android-preview-final:local \
            ls -la "/opt/android-sdk-linux/avd/${{ env.AVD_ID }}.avd/snapshots/default_boot/"

      # ── Phase 4: Tag and push ──
      - name: Generate image tags
        id: tags
        run: |
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          DATE_TAG=$(date +%Y%m%d)
          SHA_TAG=${GITHUB_SHA::7}

          TAGS="${FULL_IMAGE}:latest"
          TAGS="${TAGS},${FULL_IMAGE}:api${{ env.API_LEVEL }}"
          TAGS="${TAGS},${FULL_IMAGE}:${SHA_TAG}"
          TAGS="${TAGS},${FULL_IMAGE}:${DATE_TAG}"

          echo "tags=${TAGS}" >> "$GITHUB_OUTPUT"
          echo "Generated tags:"
          echo "${TAGS}" | tr ',' '\n'

      - name: Tag and push image
        run: |
          IFS=',' read -ra TAG_ARRAY <<< "${{ steps.tags.outputs.tags }}"
          for TAG in "${TAG_ARRAY[@]}"; do
            docker tag android-preview-final:local "${TAG}"
            docker push "${TAG}"
            echo "Pushed: ${TAG}"
          done
